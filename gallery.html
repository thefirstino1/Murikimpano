<!DOCTYPE html>
<html lang="rw">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aho Barebera Impano - Murikimpano</title>
    <link rel="stylesheet" href="assets/css/style.css">
    <style>
        .gallery-container { padding: 20px; }
        .add-item-form { margin-bottom: 30px; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .gallery-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; }
        .gallery-item { border: 1px solid #eee; padding: 15px; border-radius: 5px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .gallery-item h3 { margin-top: 0; }
    </style>
</head>
<body>

    <!-- Hano haza Menu yawe ivuye muri nav.js -->
    <div id="navbar-placeholder"><p>Loading menu...</p></div>

    <div class="container gallery-container">
        <header>
            <h1>Aho Barebera Impano</h1>
        </header>

        <main>
            <!-- Igice cya 1: Form yo kongeramo impano nshya -->
            <section class="add-item-form">
                <h2>Ongeraho Impano Nshya</h2>
                <form id="add-item-form">
                    <div class="form-group">
                        <label for="item-title">Izina ry'Impano (Umutwe)</label>
                        <input type="text" id="item-title" required>
                    </div>
                    <div class="form-group">
                        <label for="item-description">Amagambo abisobanura</label>
                        <textarea id="item-description" rows="3" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Ohereza Impano</button>
                </form>
                <p id="form-message" style="display:none; margin-top:10px;"></p>
            </section>

            <!-- Igice cya 2: Aho impano zose zigaragara -->
            <section class="gallery-display">
                <h2>Impano Ziriho</h2>
                <div id="gallery-grid" class="gallery-grid">
                    <p>Tegereza, turimo gukurura impano...</p>
                </div>
            </section>
        </main>
    </div>

    <!-- Script z'ingenzi -->
    <script type="module" src="assets/js/nav.js"></script>
    <script type="module">
        // Importa ibyo dukeneye byose
        import { auth, db } from './assets/js/firebase.js';
        import { onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-auth.js";
        import { collection, addDoc, getDocs } from "https://www.gstatic.com/firebasejs/9.6.1/firebase-firestore.js"; 

        const form = document.getElementById('add-item-form');
        const formMessage = document.getElementById('form-message');
        const galleryGrid = document.getElementById('gallery-grid');
        let currentUser = null;

        // UMURINZI: Genzura niba umuntu yarinjiye mbere yo gukora ikindi kintu
        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user; // Bika amakuru y'umukoresha uri gukora
                loadGalleryItems(); // Numara kubona ko yinjiye, hita uzana impano ziriho
            } else {
                window.location.href = 'login.html'; // Niba atarinjiye, musubize kuri login
            }
        });

        // Iyo umuntu yemeje form yo kongeramo impano
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const title = document.getElementById('item-title').value;
            const description = document.getElementById('item-description').value;
            
            if (!currentUser) {
                alert("Ugomba kuba warinjiye kugira ngo wohereze impano.");
                return;
            }

            try {
                // Ongeramo document nshya muri collection yitwa "galleryItems"
                const docRef = await addDoc(collection(db, "galleryItems"), {
                    title: title,
                    description: description,
                    authorEmail: currentUser.email, // Bika n'uwabikoze
                    createdAt: new Date() // Bika n'igihe byakorewe
                });
                console.log("Document yanditswe ifite ID: ", docRef.id);
                formMessage.textContent = "Impano yawe yoherejwe neza!";
                formMessage.style.color = 'green';
                formMessage.style.display = 'block';
                form.reset(); // Siba ibiri muri form
                loadGalleryItems(); // Hita wongera werekane impano zose harimo n'inshya
            } catch (error) {
                console.error("Ikosa ryo kongeramo document: ", error);
                formMessage.textContent = "Habaye ikosa. Ongera ugerageze.";
                formMessage.style.color = 'red';
                formMessage.style.display = 'block';
            }
        });

        // Function yo kuzana no kwerekana impano zose
        async function loadGalleryItems() {
            galleryGrid.innerHTML = '<p>Turimo gukurura impano...</p>'; // Banza usibe izari zihari
            const querySnapshot = await getDocs(collection(db, "galleryItems"));
            galleryGrid.innerHTML = ''; // Siba ubutumwa bwo gutegereza
            querySnapshot.forEach((doc) => {
                const item = doc.data();
                const itemElement = document.createElement('div');
                itemElement.classList.add('gallery-item');
                itemElement.innerHTML = `
                    <h3>${item.title}</h3>
                    <p>${item.description}</p>
                    <small>Byakozwe na: ${item.authorEmail}</small>
                `;
                galleryGrid.appendChild(itemElement);
            });
        }
    </script>
</body>
</html>
